{% extends 'global/base.html' %}
{% load static %}

{% block styles %}
    <!-- Site-specific css/js -->
    <link rel="stylesheet" type="text/css" href="{% static 'global/css/taxid_color.css' %}" id="taxid-color-stylesheet"/>
    <link rel="stylesheet" type="text/css" href="{% static 'global/css/tag_color.css' %}"/>
    <link href="{% static 'global/css/annotype_color.css' %}" rel="stylesheet"/>
    <link href="{% static 'pathway-maps/css/pathway-maps.css' %}" rel="stylesheet"/>
    <script src="{% static 'global/js/query-groups.js' %}"></script>

    <!-- Pathway SVG library -->
    <script src="{% static 'pathway-maps/js/PathwaySvgLib.js' %}"></script>
    <script src="{% static 'pathway-maps/js/chroma.min.js' %}"></script>
    <script src="{% static 'pathway-maps/js/html2canvas.min.js' %}"></script>

    <!-- autocomplete -->
    <link href="{% static 'global/css/jquery.tag-editor.css' %}" rel="stylesheet"/>
    <script src="{% static 'global/js/jquery.caret.min.js' %}"></script>
    <script src="{% static 'global/js/jquery.tag-editor.min.js' %}"></script>

{% endblock %}

{% block sidebar %}

    <div class="sidebar-subcontent form-check form-check-inline">
        <label class="form-check-label" for="colorize-tax-checkbox"><a>Colorize taxonomy?</a></label>
        <input class="form-check-input" type="checkbox" id="colorize-tax-checkbox" onclick="toggle_colorize_tax()"
               checked>
    </div>

    <div class="sidebar-subcontent form-check form-check-inline">
        <button type="button" class="btn btn-light" onclick="savePng('pathway-map-container')">Save as PNG</button>
    </div>

    <div class="sidebar-subcontent form-check form-check-inline">
        <button type="button" class="btn btn-light" onclick="saveSvg('pathway-map-container')">Save as SVG</button>
    </div>

{% endblock %}

{% block body %}

    <section>
        <div class="container">
            <form>
                {% csrf_token %}
                <div class="form-group row">
                    <label for="get-map" class="col-sm-2 col-form-label" style="white-space: nowrap">Pathway Map:</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <input type="text" class="form-control" id="get-map"
                                   value="{% if map %}{{ map.slug }} : {{ map.title }}{% endif %}">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true"
                                        style="height: 38px" aria-expanded="false" onclick="rankPathwaysDropdown()">Select
                                </button>
                                <div id="score-pathways-dropdown" class="dropdown-menu dropdown-menu-right">
                                    <div id="score-pathways-dropdown-spinner" class="dropdown-item" style="text-align: center" hidden>
                                        <div class="spinner-border text-dark" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </div>
                                    <div id="score-pathways-dropdown-message" style="max-height: 30rem;overflow: auto"></div>
                                    <div id="score-pathways-dropdown-content" style="max-height: 30rem;overflow: auto"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="query-genomes"></div>

                <button type="button" class="btn btn-primary" onclick="submit_function()">Submit</button>

                <button type="button" class="btn-sm btn-success float-right" onclick="addGenomesGroup(queryGenomes)" title=""
                        data-original-title="Add group">Add group
                </button>

            </form>

            {% if map %}
                <hr class="featurette-divider">

                <button type="button" class="btn btn-light" data-toggle="collapse" href="#real-div" aria-expanded="false" aria-controls="real-div"
                >Show query
                </button>

                <form id="real-div" class="form-group collapse">
                    <div class="form-group row">
                        <label for="real-map" class="col-sm-2 col-form-label" style="white-space: nowrap">Pathway Map:</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="real-map" value="{{ map.slug }} : {{ map.title }}" readonly>
                        </div>
                    </div>

                    {% for magic_query_manager in magic_query_managers %}
                        <div>
                            <label for="real-genomes-{{ forloop.counter }}">Genomes
                                (group {{ forloop.counter }}): {{ magic_query_manager.all_genomes|length }} genomes</label>
                            <div class="read-only-div" id="real-genomes-{{ forloop.counter }}">
                                {% for genome in magic_query_manager.all_genomes %}{{ genome.html|safe }}{% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </form>

                </div>
            {% endif %}

    </section>

    <section style="padding-top: 1rem">

        <div id="center-content">
            <div id="pathway-map-container">
                <!-- pathway map svg -->
            </div>
        </div>

    </section>
{% endblock %}

{% block end %}
    <script>
        "use strict"
        const local_genome_to_species = {{ genome_to_species|safe }};

        const type_dict = {{ type_dict|safe }};

        const initial_queries = {{ initial_queries|safe }};

        const queryGenomes = $('#query-genomes')

        $(document).ready(function () {
            if (initial_queries.length == 0) {
                addGenomesGroup(queryGenomes)  // add empty group
            } else {
                for (const genomes of initial_queries) {
                    addGenomesGroup(queryGenomes, genomes)
                }
            }
        })


        $(document).ready(function () {
            $("#get-map").autocomplete({
                source: '{% url "website:api-autocomplete-pathway" %}',
                minLength: 2,
            })

            $('.ogb-tag')
                .ogbTooltip()
                .click(function () {
                    showGenomeClickMenu(event)
                })

            {% if map %}
                $('#pathway-map-container').load(`/files_html/{{ PATHWAY_MAPS_RELATIVE }}/{{ map.filename }}`.replace(/\s/g, '%20'), function () {
                    $('.shape')
                        .ogbTooltip()
                        .click(function (event) {
                            showMapClickMenu(event, this)
                        })

                    {% if groups_of_genomes %}
                        let svg, groupsOfOrganisms, colors;
                        highlightGroupsOfOrganisms(
                            svg = document.getElementById('pathway-map-container').firstChild,
                            groupsOfOrganisms = {{ groups_of_genomes|safe }},
                            colors = ['yellow', 'red']
                        )
                    {% endif %}

                })
            {% endif %}
        })

        function rankPathwaysDropdown() {
            const dropdown = $('#score-pathways-dropdown')
            const dropdownMessage = $('#score-pathways-dropdown-message')
            const dropdownContent = $('#score-pathways-dropdown-content')
            const spinner = $('#score-pathways-dropdown-spinner')
            spinner.attr('hidden', false)

            let groupsOfGenomes = {}
            let counter = 1
            queryGenomes.find('.get-genomes').each(function () {
                const genomes = extractQuery(this)
                if (genomes.length > 0) { // skip empty groups
                    groupsOfGenomes[`g${counter}`] = genomes
                    counter += 1
                }
            })

            $.post('/api/score-pathway-maps/', groupsOfGenomes, function (data, statusText, xhr) {
                spinner.attr('hidden', true)
                dropdownMessage.empty()
                dropdownContent.empty()

                if (xhr.status !== 200 || data['success'] !== 'true') {
                    let msg = 'result' in data ? data['result'] : ''
                    dropdownMessage.append(`<a class="dropdown-item bg-warning">Failed to get ranking. ${msg}</a>`)
                } else {
                    dropdownMessage.append(`<a class="dropdown-item bg-success">${data['message']}</a>`)
                    $(data['result']).each(function () {

                        let score = ''
                        if ('score' in this && this['score'] !== 0 && this['score'] !== 'none') {
                            score = `<button type="button" class="btn btn-outline-secondary btn-sm" disabled>score:${this['score'].toFixed(4)}</button>`
                        }
                        dropdownContent.append(`
                        <div class="dropdown-item pathway-dropdown">
                            <p>${this['slug']} : ${this['title']}</p>
                            <div>
                                ${score}
                                <button type="button" class="btn btn-primary btn-sm" data-slug="${this['slug']}">open</button>
                            </div>
                        </div>`)
                    })
                    dropdown.find('.pathway-dropdown').on("click", function (event) {
                        $('#get-map').val(this.children[0].textContent)
                    })
                    dropdown.find('.btn-primary').on("click", function (event) {
                            data = groupsOfGenomes
                            data['map'] = $(this).data('slug')
                            redirect('/pathway/?postrequest=true', data, '_blank')
                            event.stopPropagation()
                        }
                    )


                }

                window.scrollTo(window.scrollX + 1, window.scrollY)  // update position of dropdown
            }, "json")
        }

        function submit_function() {
            const map_slug = $('#get-map').val().split(' : ')[0]
            let groupsOfGenomes = []
            let allGenomes = new Set()
            queryGenomes.find('.get-genomes').each(function () {
                const genomes = extractQuery(this)
                groupsOfGenomes.push(genomes)
                allGenomes = new Set([...allGenomes, ...genomes])
            })
            allGenomes = Array.from(allGenomes)

            $.when(validate_pathwaymap(map_slug), validate_genomes(allGenomes)).done(function (map_valid, genomes_valid) {
                map_valid = map_valid[2].responseJSON['success']
                genomes_valid = genomes_valid[2].responseJSON['success']

                console.log(map_valid, genomes_valid)

                if (map_valid) {
                    $('#get-map').removeClass('is-invalid')
                } else {
                    $('#get-map').addClass('is-invalid')
                }

                if (genomes_valid) {
                    $('.get-genomes').removeClass('is-invalid')
                } else {
                    $('.get-genomes').addClass('is-invalid')
                }

                if (map_valid && genomes_valid) {

                    let data = {'map': map_slug}
                    groupsOfGenomes.forEach(function (genomes, i) {
                        data[`g${i + 1}`] = genomes
                    })

                    goToPageWithData('/pathway', data)
                }
            })
        }

        let showMapClickMenu = function (event, shape) {
            console.log('showMapClickMenu event:', event, 'shape', shape)
            const dataGenomes = $(shape).data('organisms')
            const dataAnnotations = $(shape).data('annotations')

            // initiate context menu
            let cm = new ClickMenu(event, 'map-context-menu')

            // coverage
            let isCovered = false
            for (const [groupId, genomes] of Object.entries(dataGenomes)) {
                const covering = dataGenomes[groupId]['covering'].size
                if (covering > 0) {
                    isCovered = true
                    break
                }
            }

            // coverage
            if (isCovered) {
                cm.appendHeader('Coverage')

                for (const [groupId, genomes] of Object.entries(dataGenomes)) {
                    const covering = genomes['covering'].size
                    const notCovering = genomes['not-covering'].size
                    const total = covering + notCovering
                    let relative = 0
                    let percentage = 0
                    if (total !== 0) {
                        relative = covering / total
                        percentage = Math.round(covering / total * 1000) / 10
                    }
                    const color = covering === 0 ? 'lightgrey' : chroma.mix('yellow', 'red', relative)

                    // coverage percentage
                    let el = `
                        <div class="dropdown-item" style="background-color: ${color}" data-toggle="collapse" href="#collapse-strains-${groupId}" role="button" aria-expanded="false" aria-controls="collapse-strains-${groupId}">
                            ${groupId}: ${percentage} % (${covering} out of ${total})
                            <img src="/static/global/ionicons/ios-arrow-down.svg" style="height: 1.5rem" class="float-right">
                        </div>
                        <div class="collapse" id="collapse-strains-${groupId}" style="margin: 0 0.2rem 1rem 0.2rem">
`

                    // covering genomes
                    if (covering > 0) {
                        el += `<h6 class="dropdown-header context-menu-header" style="padding-bottom: 0.1rem">Positive genomes ${groupId}</h6>`
                        el += $("<div/>").append(create_read_only_genome_div(Array.from(genomes['covering']), local_genome_to_species, 'positive', '#map-context-menu')).html()
                    }

                    // non-covering genomes
                    if (notCovering > 0) {
                        el += `<h6 class="dropdown-header context-menu-header" style="padding-bottom: 0.1rem">Negative genomes ${groupId}</h6>`
                        el += $("<div/>").append(create_read_only_genome_div(Array.from(genomes['not-covering']), local_genome_to_species, 'positive', '#map-context-menu')).html()
                    }

                    el += `</div>`

                    cm.appendElement(el)
                }
            }

            // annotations
            cm.appendHeader('Annotations')
            $.each(dataAnnotations, function (index) {
                let nCovered = new Array()
                for (const [groupId, genomes] of Object.entries(dataGenomes)) {
                    nCovered.push(this['organisms'][groupId]['covering'].size)
                }
                const isCovered = nCovered.reduce((a, b) => a + b, 0) !== 0
                const annoType = type_dict[this['type']]
                const description = ('description' in this) ? decodeURIComponent(this['description']) : ''
                const tag = (annoType === 'ignore') ? "<div class='annotation ogb-tag' data-annotype='fake'>" + this['name'] + "</div>" : `<div class="annotation ogb-tag" onclick="console.log('input', event, this);showAnnotationClickMenu(event, 'auto', '#map-context-menu', '#map-context-menu .positive' )" data-annotype="${annoType}" title="${description}">${this['name']}</div>`

                let el = `
                    <div style="display: inline-flex">
                        <div class="anno-dropdown-item dropdown-item context-menu-icon context-menu-icon-annotation">${tag}${(isCovered) ? ' (' + nCovered.join(':') + ')' : ''}</div>
                        <div class="btn-group dropabrowright">
                            <button class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 1rem; padding: 0rem 0.8rem;"></button>
                            <div class="dropdown-menu" style="width: 400px">
                            <h6 class="dropdown-header context-menu-header">Description</h6>
                            <a class="dropdown-item context-menu-icon context-menu-icon-copy" style="display: flex; flex-wrap: wrap; white-space: break-spaces;">${description}</a>`

                if (isCovered) {
                    for (const [groupId, genomes] of Object.entries(dataGenomes)) {

                        nCovered.push(this['organisms'][groupId]['covering'].size)

                        el += `
                            <h6 class="dropdown-header context-menu-header">Positive genomes ${groupId}</h6>
                            <div class="read-only-div"> ${create_read_only_genome_div(Array.from(this['organisms'][groupId]['covering']), local_genome_to_species, 'positive', '#map-context-menu').html()} </div>`

                    }
                }

                el += `
        </div>
    </div>
</div>`
                cm.appendElement(el)
            })

            // summary
            if (isCovered) {
                let allCovering = new Set()
                let allNotCovering = new Set()
                for (const [groupId, genomes] of Object.entries(dataGenomes)) {
                    allCovering = new Set([...allCovering, ...genomes['covering']])
                    allNotCovering = new Set([...allNotCovering, ...genomes['not-covering']])
                }

                cm.appendElement(`
                    <h6 class="dropdown-header context-menu-header">Positive genomes</h6>
                    <div class="read-only-div"> ${create_read_only_genome_div(Array.from(allCovering), local_genome_to_species, 'positive', '#map-context-menu').html()} </div>
                    <h6 class="dropdown-header context-menu-header">Negative genomes</h6>
                    <div class="read-only-div"> ${create_read_only_genome_div(Array.from(allNotCovering), local_genome_to_species, 'negative', '#map-context-menu').html()} </div>`
                )
            }

            cm.show()

            $('#map-context-menu .ogb-tag').ogbTooltip()
        }


    </script>
{% endblock %}