{% extends 'global/base.html' %}

{% load static %}

{% block styles %}
    <!-- Site-specific css/js -->
    <link rel="stylesheet" type="text/css" href="{% static 'annotation_search/css/annotation_search.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'global/css/annotype_color.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'global/css/tag_color.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'global/css/taxid_color.css' %}" id="taxid-color-stylesheet"/>

    <script src="{% static 'global/js/query-groups.js' %}"></script>

    <script src="{% static 'global/js/select2.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'global/css/select2.min.css' %}"/>

    <!-- autocomplete -->
    <link href="{% static 'global/css/jquery.tag-editor.css' %}" rel="stylesheet"/>
    <script src="{% static 'global/js/jquery.caret.min.js' %}"></script>
    <script src="{% static 'global/js/jquery.tag-editor.min.js' %}"></script>

    <!-- SortableJS - https://github.com/SortableJS/Sortable -->
    <script src="{% static 'global/js/Sortable.min.js' %}"></script>

    <link rel="stylesheet" type="text/css" href="{% static 'global/css/genome_filter.css' %}"/>

{% endblock %}


{% block body %}

    <div class="container">

        <h1>Genomes</h1>

        <div id="collapse-header" data-toggle="collapse" data-target="#collapseFilters" aria-expanded="false" aria-controls="collapseFilters"
             onclick="activateDropdownSelect()">
            <span>Expand filters</span>
            <img src="{% static 'global/ionicons/ios-arrow-down.svg' %}" alt="expand">
        </div>

        <div class="collapse" id="collapseFilters">
            <br>

            <form method="GET" id="form">

                <div class="input-group mb-3" id="form_columns">
                    <div class="input-group-prepend">
                        <label class="input-group-text" id="label_columns"
                               for="id_columns">Columns</label>
                    </div>
                    <input name="columns" value="" hidden>
                    <div class="form-control" id="id_columns">

                        <div>
                            <h6>Sort columns</h6>
                            <ul id="sortable-selected" class="sortable grid">
                                {% for field_id, filter_field in filter_fields.items %}{% if field_id in columns %}
                                    <li data-selector="{{ field_id }}">{{ filter_field.label }}{% endif %}{% endfor %}
                            </ul>
                        </div>
                        <div>
                            <h6>Available Columns</h6>
                            <ul id="sortable-available" class="sortable grid">
                                {% for field_id, filter_field in filter_fields.items %}{% if field_id not in columns %}
                                    <li data-selector="{{ field_id }}">{{ filter_field.label }}{% endif %}{% endfor %}
                            </ul>
                        </div>

                    </div>
                </div>

                {% for field_id, filter_field in filter_fields.items %}
                    <div class="input-group mb-3" id="form_{{ field_id }}" {% if filter_field.hidden %}hidden{% endif %}>
                        <div class="input-group-prepend">
                            <label class="input-group-text" id="label_{{ field_id }}"
                                   for="id_{{ field_id }}">{{ filter_field.label }}</label>
                        </div>
                        {% if filter_field.multiple %}
                            <input name="{{ field_id }}" value="" hidden>
                            <select class="custom-select" id="id_{{ field_id }}" multiple="multiple">
                                {% for choice, verbose in filter_field.choices %}
                                    <option value="{{ choice }}"
                                            {% if choice in filter_field.data %} selected{% endif %}
                                    >{{ verbose }}</option>{% endfor %}
                            </select>
                        {% elif filter_field.choices %}
                            <select class="custom-select" name="{{ field_id }}" id="id_{{ field_id }}">
                                {% for choice, verbose in filter_field.choices %}
                                    <option value="{{ choice }}"
                                            {% if choice == filter_field.data %} selected{% endif %}
                                    >{{ verbose }}</option>{% endfor %}
                            </select>
                        {% else %}
                            <input type="text" class="form-control" name="{{ field_id }}"
                                   aria-label="{{ filter_field.label }}" aria-describedby="label_{{ field_id }}"
                                   value="{{ filter_field.data }}">
                        {% endif %}
                    </div>
                {% endfor %}

                <div class="input-group mb-3" id="form_paginate_by">
                    <div class="input-group-prepend">
                        <label class="input-group-text" id="label_paginate_by"
                               for="id_paginate_by">Page size</label>
                    </div>

                    <select class="custom-select" name="paginate_by" id="id_paginate_by">

                        {% for option in pagination_options %}
                            <option value="{{ option }}" {% if option == paginated_by %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>

                </div>

            </form>
            <button type="button" class="btn btn-primary" onclick="submitFunction()">Submit</button>


            {% if magic_query_manager %}
                <div class="">

                    <hr class="featurette-divider">

                    <button type="button" class="btn btn-light" data-toggle="collapse" href="#real-div" aria-expanded="false" aria-controls="real-div"
                    >Show query
                    </button>

                    <form id="real-div" class="collapse">
                        <div class="form-group">
                            <label for="real-genomes-1">Genomes:</label>
                            <div class="read-only-div" id="real-genomes">
                                {% for genome in magic_query_manager.all_genomes %}{{ genome.html|safe }}{% endfor %}
                            </div>
                        </div>

                    </form>
                </div>

            {% endif %}

        </div>

        {% include "global/pagination_snippet.html" %}


        <table id="annotation-list">
            <tr>
                {% for c, data in columns_data.items %}
                    <th>{{ data.label }}</th>{% endfor %}
            </tr>
            {% for row in table %}
                <tr>
                    {% for cell in row %}
                        <td>{{ cell|safe }}</td>{% endfor %}
                </tr>
            {% endfor %}
        </table>


        {% include "global/pagination_snippet.html" %}

    </div>

{% endblock %}

{% block end %}
    <script>
        "use strict"

        const form = document.getElementById('form')
        const sortable_selected = document.getElementById('sortable-selected')
        const sortable_available = document.getElementById('sortable-available')

        $(document).ready(function () {
            new Sortable.create(sortable_selected, {
                animation: 150,
                multiDrag: true, // Enable multi-drag
                selectedClass: 'selected', // The class applied to the selected items
                group: 'shared', // set both lists to same group
            })
            new Sortable.create(sortable_available, {
                animation: 150,
                multiDrag: true, // Enable multi-drag
                selectedClass: 'selected', // The class applied to the selected items
                group: 'shared', // set both lists to same group
            })
        })


        $(document).ready(function () {
            $('.ogb-tag.genome')
                .ogbTooltip()
                .click(function (event) {
                    showGenomeClickMenu(event)
                })
            $('.ogb-tag.organism')
                .ogbTooltip()
                .click(function (event) {
                    showOrganismClickMenu(event)
                })
        })

        const activateDropdownSelect = function () {
            setTimeout(function () {
                {% for field_id, filter_field in filter_fields.items %}{% if filter_field.choices %}{% if filter_field.multiple %}
                $('#id_{{ field_id }}').select2({multiple: true})
                {% else %}
                $('#id_{{ field_id }}').select2()
                {% endif %}{% endif %}{% endfor %}
            }, 10)
        }


        $(form).submit(function () {
            // copy content of multiples into new inputs, comma-separated
            $(form).find('select[multiple]').each(function (i, select) {
                const value = $(select).val().join(',')  // array
                const name = select.id.substr(3)
                const input = $(form).find('input[name=' + name + ']')
                input.attr('value', value)
            })

            // remove empty filters
            $(form).find('input[type!="radio"][value=""],select:not(:has(option:selected[value!=""]))').attr('name', '')

        })

        const submitFunction = function () {
            console.log(`Form Submitted! Time stamp: ${event.timeStamp}`)
            $(form).submit()
        }

    </script>
{% endblock %}
