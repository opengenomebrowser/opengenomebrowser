{% extends 'global/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block styles %}
    <!-- Site-specific css/js -->
    <link rel="stylesheet" type="text/css" href="{% static 'annotation_search/css/blast.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'global/css/annotype_color.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'global/css/taxid_color.css' %}"
          id="taxid-color-stylesheet"/>

    <!-- autocomplete -->
    <link href="{% static 'website/css/jquery-ui.css' %}" rel="stylesheet"/>
    <link href="{% static 'kegg/css/jquery.tag-editor.css' %}" rel="stylesheet"/>
    <script src="{% static 'kegg/js/jquery.caret.min.js' %}"></script>
    <script src="{% static 'kegg/js/jquery.tag-editor.min.js' %}"></script>

    <!-- django form -->
    {{ form.media }}

    <!-- blasterjs -->
    <script src="{% static 'global/js/blaster.min.js' %}"></script>
    <script src="{% static 'global/js/html2canvas.min.js' %}"></script>

{% endblock %}

{% block sidebar %}

    <div class="sidebar-subcontent form-check form-check-inline">
        <label class="form-check-label" for="colorize-tax-checkbox"><a>Colorize taxonomy?</a></label>
        <input class="form-check-input" type="checkbox" id="colorize-tax-checkbox" onclick="toggle_colorize_tax()"
               checked>
    </div>

{% endblock %}

{% block body %}


    <section>

        {% if submitted %}
            <p class="success">
                Your message was submitted successfully.
            </p>

        {% else %}

            <div class="container">
                <form method="post" id="blast-form" action="{% url "website:blast-submit" %}">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <button type="submit" class="btn btn-success">Blast!</button>
                </form>
            </div>

        {% endif %}


    </section>

    <div id="blast-multiple-alignments"></div>
    <div id="blast-alignments-table"></div>
    <div id="blast-single-alignment"></div>


{% endblock %}

{% block end %}

    <script>

        "use strict";

        let current_annotations = [];
        let current_genomes = [];

        let genome_to_species;

        $(document).ready(function () {
            genome_to_species = init_autocomplete_genomes("#id_genomes");
        });


        var blasterjs = require("biojs-vis-blasterjs");

        let frm = $('#blast-form');
        frm.submit(function () {
            // remove old results
            $("#blast-multiple-alignments").empty();
            $("#blast-alignments-table").empty();
            $("#blast-single-alignment").empty();

            // load new blast results
            $.ajax({
                type: frm.attr('method'),
                url: frm.attr('action'),
                data: frm.serialize(),
                success: function (data) {
                    var instance = new blasterjs({
                        string: data,
                        multipleAlignments: "blast-multiple-alignments",
                        alignmentsTable: "blast-alignments-table",
                        singleAlignment: "blast-single-alignment"
                    })


                },
                error: function (data) {
                    console.log('BLAST FAILED!', data)
                }
            });
            return false;
        })


    </script>


{% endblock %}
